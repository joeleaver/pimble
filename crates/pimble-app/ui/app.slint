// Pimble Desktop Application UI
// Built with Slint - https://slint.dev

import { Button, LineEdit, ListView, ScrollView, VerticalBox, HorizontalBox, StandardButton, ComboBox, TextEdit } from "std-widgets.slint";
import { Theme } from "theme.slint";
import { CosmicTextEditor } from "editor/cosmic_text_editor.slint";

// Embed Codicon font for VS Code-style icons
import "fonts/codicon.ttf";
// Embed Material Design Icons font for table toolbar
import "fonts/materialdesignicons-webfont.ttf";

// Tree item data model
export struct TreeItemData {
    id: string,
    label: string,
    icon: string,
    depth: int,
    expandable: bool,
    expanded: bool,
    is-store: bool,
}

// Menu item data model
export struct MenuItemData {
    label: string,
    shortcut: string,
    action-id: string,
    enabled: bool,
    is-separator: bool,
}

// Application callbacks
export global AppCallbacks {
    // Menu actions
    callback menu-item-clicked(string);

    // Tree actions
    callback tree-item-clicked(string);
    callback tree-item-toggle(string);

    // Window actions
    callback window-minimize();
    callback window-maximize();
    callback window-close();
    callback start-window-drag();
    callback start-window-resize(string);  // direction: "n", "s", "e", "w", "ne", "nw", "se", "sw"

    // Toolbar actions
    callback new-store();
    callback open-store();
    callback new-node();

    // Editor actions
    callback content-changed(string);

    // Cosmic text editor callbacks
    callback cosmic-key-pressed(string, bool, bool, bool);  // key, shift, ctrl, alt
    callback cosmic-mouse-clicked(float, float);             // x, y in pixels
    callback cosmic-mouse-dragged(float, float);             // x, y in pixels
    callback cosmic-request-render(float, float, float, float);  // Request render (width, height, scroll-y, zoom)
    callback cosmic-focus-changed(bool);                     // Focus state
    callback cosmic-blink-update();                          // Cursor blink update

    // Table toolbar callbacks
    callback table-add-row-above();
    callback table-add-row-below();
    callback table-add-column-left();
    callback table-add-column-right();
    callback table-delete-row();
    callback table-delete-column();
}

// Window control button using Codicon font (VS Code style)
component WinButton inherits Rectangle {
    in property <string> btn-type;  // "min", "max", "close"

    callback clicked();

    width: 46px;
    height: 30px;
    background: Theme.transparent-color;

    // Codicon glyphs for VS Code style window controls
    Text {
        text: btn-type == "min" ? "\u{eaba}" : (btn-type == "max" ? "\u{eab9}" : "\u{eab8}");
        font-family: "codicon";
        font-size: 14px;
        color: (btn-type == "close" && touch.has-hover) ? #ffffff : Theme.text;
        horizontal-alignment: center;
        vertical-alignment: center;
    }

    touch := TouchArea {
        clicked => { root.clicked(); }
    }

    states [
        hovered when touch.has-hover: {
            background: btn-type == "close" ? #e81123 : Theme.hover;
        }
    ]
}

// Menu bar button (VS Code style)
component MenuBarButton inherits Rectangle {
    in property <string> text;
    in property <bool> active: false;
    in property <bool> menu-mode: false;  // When true, hover opens menu

    callback clicked();
    callback hovered();

    width: self.preferred-width;
    height: 30px;
    background: active ? Theme.menu-hover : Theme.transparent-color;
    border-radius: 4px;

    HorizontalLayout {
        padding-left: 8px;
        padding-right: 8px;
        alignment: center;

        Text {
            text: root.text;
            color: Theme.text;
            font-size: 13px;
            vertical-alignment: center;
        }
    }

    touch := TouchArea {
        clicked => { root.clicked(); }
        pointer-event(event) => {
            if (menu-mode && touch.has-hover && event.kind == PointerEventKind.move) {
                root.hovered();
            }
        }
    }

    states [
        hovered when !active && touch.has-hover: {
            background: Theme.hover;
        }
    ]
}

// VS Code style dropdown menu
component DropdownMenu inherits Rectangle {
    in property <[MenuItemData]> items;
    in property <length> menu-x: 0px;
    in property <length> menu-y: 0px;

    callback item-clicked(string);
    callback close();

    x: menu-x;
    y: menu-y;
    width: 240px;
    // Height is determined by content
    height: menu-layout.preferred-height;
    background: Theme.menu-bg;
    border-width: 1px;
    border-color: Theme.menu-border;
    border-radius: 6px;

    // Shadow
    drop-shadow-blur: 16px;
    drop-shadow-color: #000000a0;
    drop-shadow-offset-x: 0px;
    drop-shadow-offset-y: 4px;

    menu-layout := VerticalLayout {
        padding-top: 6px;
        padding-bottom: 6px;

        for item in items: Rectangle {
            height: item.is-separator ? 9px : 26px;
            background: Theme.transparent-color;
            border-radius: 0px;

            if item.is-separator: Rectangle {
                y: 4px;
                x: 12px;
                width: parent.width - 24px;
                height: 1px;
                background: Theme.border;
            }

            if !item.is-separator: HorizontalLayout {
                padding-left: 10px;
                padding-right: 10px;
                spacing: 8px;

                // Menu item label
                Text {
                    text: item.label;
                    color: item.enabled ? Theme.text : Theme.text-disabled;
                    font-size: 13px;
                    vertical-alignment: center;
                    horizontal-stretch: 1;
                }

                // Keyboard shortcut
                Text {
                    text: item.shortcut;
                    color: Theme.text-muted;
                    font-size: 13px;
                    vertical-alignment: center;
                    horizontal-alignment: right;
                }
            }

            item-touch := TouchArea {
                enabled: !item.is-separator && item.enabled;
                clicked => {
                    root.item-clicked(item.action-id);
                    root.close();
                }
            }

            states [
                hovered when !item.is-separator && item.enabled && item-touch.has-hover: {
                    background: Theme.menu-hover;
                }
            ]
        }
    }
}

// Tree view item component
component TreeItem inherits Rectangle {
    in property <TreeItemData> item;
    in property <bool> selected: false;

    callback clicked();
    callback toggle();

    height: 22px;
    background: selected ? Theme.selected : (touch.has-hover ? Theme.hover : transparent);

    HorizontalLayout {
        padding-left: item.depth * 16px + 8px;
        spacing: 4px;
        alignment: start;

        // Expand/collapse icon
        Rectangle {
            width: 16px;
            height: 100%;

            Text {
                text: item.expandable ? (item.expanded ? "▼" : "▶") : "";
                color: Theme.text-muted;
                font-size: 8px;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }

        // Icon
        Text {
            text: item.icon;
            color: item.is-store ? #dcb67a : Theme.text-muted;
            font-size: 14px;
            vertical-alignment: center;
        }

        // Label
        Text {
            text: item.label;
            color: Theme.text;
            font-size: 13px;
            vertical-alignment: center;
            overflow: elide;
            horizontal-stretch: 1;
        }
    }

    // Main touch area - covers the whole item for selection
    touch := TouchArea {
        width: 100%;
        height: 100%;
        clicked => {
            // Check if click is in the expand area
            if (self.pressed-x < item.depth * 16px + 8px + 16px && item.expandable) {
                root.toggle();
            } else {
                root.clicked();
            }
        }
    }
}

// Main application window
export component AppWindow inherits Window {
    title: "Pimble";
    no-frame: true;
    min-width: 800px;
    min-height: 600px;
    background: transparent;

    // State properties
    in-out property <string> connection-status: "Disconnected";
    in-out property <[TreeItemData]> tree-items: [];
    in-out property <string> selected-item-id: "";
    in-out property <string> node-title: "";
    in-out property <string> node-content: "";

    // Cosmic text editor state
    in-out property <image> cosmic-editor-image;       // Rendered image from cosmic-text
    in-out property <string> cosmic-editor-text: "";   // Text content for cosmic editor
    in-out property <float> cosmic-content-height: 0;  // Total content height for scrolling
    in-out property <float> cosmic-max-scroll-y: 0;    // Maximum scroll position
    in-out property <float> cosmic-scroll-y: 0;        // Current scroll position

    // Table toolbar state
    in-out property <bool> table-cell-selected: false;
    in-out property <float> table-toolbar-x: 0;
    in-out property <float> table-toolbar-y: 0;

    // Menu state
    in-out property <string> active-menu: "";
    in-out property <[MenuItemData]> file-menu-items: [];
    in-out property <[MenuItemData]> edit-menu-items: [];
    in-out property <[MenuItemData]> view-menu-items: [];
    in-out property <[MenuItemData]> help-menu-items: [];

    // Main container with rounded corners (with margin for shadow/transparency)
    Rectangle {
        x: 1px;
        y: 1px;
        width: parent.width - 2px;
        height: parent.height - 2px;
        background: Theme.editor-bg;
        border-radius: 8px;
        clip: true;  // Clip content to rounded corners

        // Drop shadow for depth
        drop-shadow-blur: 16px;
        drop-shadow-color: #00000060;
        drop-shadow-offset-x: 0px;
        drop-shadow-offset-y: 2px;

        VerticalLayout {
            // Menu bar (VS Code style)
            Rectangle {
                height: 30px;
                background: Theme.menubar-bg;
                // Round top corners only
                border-top-left-radius: 8px;
                border-top-right-radius: 8px;

            HorizontalLayout {
                padding-left: 12px;
                spacing: 0px;

                // App title with gradient
                Rectangle {
                    width: 60px;
                    height: 30px;

                    Text {
                        text: "Pimble";
                        font-size: 14px;
                        font-weight: 600;
                        color: @linear-gradient(90deg, #61afef 0%, #c678dd 100%);
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }

                    // Make title bar draggable
                    TouchArea {
                        moved => { AppCallbacks.start-window-drag(); }
                    }
                }

                // Menu buttons
                MenuBarButton {
                    text: "File";
                    active: active-menu == "file";
                    menu-mode: active-menu != "";
                    clicked => { active-menu = active-menu == "file" ? "" : "file"; }
                    hovered => { if (active-menu != "") { active-menu = "file"; } }
                }

                MenuBarButton {
                    text: "Edit";
                    active: active-menu == "edit";
                    menu-mode: active-menu != "";
                    clicked => { active-menu = active-menu == "edit" ? "" : "edit"; }
                    hovered => { if (active-menu != "") { active-menu = "edit"; } }
                }

                MenuBarButton {
                    text: "View";
                    active: active-menu == "view";
                    menu-mode: active-menu != "";
                    clicked => { active-menu = active-menu == "view" ? "" : "view"; }
                    hovered => { if (active-menu != "") { active-menu = "view"; } }
                }

                MenuBarButton {
                    text: "Help";
                    active: active-menu == "help";
                    menu-mode: active-menu != "";
                    clicked => { active-menu = active-menu == "help" ? "" : "help"; }
                    hovered => { if (active-menu != "") { active-menu = "help"; } }
                }

                // Spacer (draggable area)
                Rectangle {
                    horizontal-stretch: 1;
                    TouchArea {
                        moved => { AppCallbacks.start-window-drag(); }
                    }
                }

                // Window controls
                WinButton {
                    btn-type: "min";
                    clicked => { AppCallbacks.window-minimize(); }
                }
                WinButton {
                    btn-type: "max";
                    clicked => { AppCallbacks.window-maximize(); }
                }
                WinButton {
                    btn-type: "close";
                    clicked => { AppCallbacks.window-close(); }
                }
            }
        }

        // Toolbar
        Rectangle {
            height: 35px;
            background: Theme.sidebar-bg;
            border-width: 0px;
            border-color: Theme.border;

            HorizontalLayout {
                padding: 4px;
                spacing: 4px;

                Button {
                    text: "New Store";
                    clicked => { AppCallbacks.new-store(); }
                }

                Button {
                    text: "Open Store";
                    clicked => { AppCallbacks.open-store(); }
                }

                Button {
                    text: "New Node";
                    clicked => { AppCallbacks.new-node(); }
                }

                // Spacer
                Rectangle { horizontal-stretch: 1; }
            }
        }

        // Main content area
        HorizontalLayout {
            vertical-stretch: 1;

            // Sidebar (Tree panel)
            Rectangle {
                width: 250px;
                background: Theme.sidebar-bg;
                border-width: 1px;
                border-color: Theme.border;

                VerticalLayout {
                    // Sidebar header
                    Rectangle {
                        height: 35px;

                        HorizontalLayout {
                            padding: 8px;

                            Text {
                                text: "EXPLORER";
                                color: Theme.text-muted;
                                font-size: 11px;
                                font-weight: 600;
                                vertical-alignment: center;
                            }
                        }
                    }

                    // Tree view - using ListView for proper scrolling/rendering
                    ListView {
                        vertical-stretch: 1;

                        for item in tree-items: TreeItem {
                            item: item;
                            selected: item.id == selected-item-id;
                            clicked => {
                                selected-item-id = item.id;
                                AppCallbacks.tree-item-clicked(item.id);
                            }
                            toggle => {
                                AppCallbacks.tree-item-toggle(item.id);
                            }
                        }
                    }
                }
            }

            // Splitter
            Rectangle {
                width: 1px;
                background: Theme.border;
            }

            // Content area (Node viewer)
            Rectangle {
                horizontal-stretch: 1;
                background: Theme.editor-bg;

                VerticalLayout {
                    // Title bar
                    if node-title != "": Rectangle {
                        height: 40px;

                        HorizontalLayout {
                            padding: 12px;
                            spacing: 12px;

                            Text {
                                text: node-title;
                                color: Theme.text-bright;
                                font-size: 16px;
                                font-weight: 500;
                                vertical-alignment: center;
                                horizontal-stretch: 1;
                            }

                            Text {
                                text: "Debug View: Source | Visual";
                                color: Theme.text-muted;
                                font-size: 12px;
                                vertical-alignment: center;
                            }
                        }
                    }

                    // Side-by-side editor for debugging: Source (left) + Visual (right)
                    if node-title != "": HorizontalLayout {
                        vertical-stretch: 1;
                        spacing: 0px;

                        // Source Editor (left panel)
                        Rectangle {
                            horizontal-stretch: 1;
                            background: #1e1e1e;

                            VerticalLayout {
                                // Source header
                                Rectangle {
                                    height: 24px;
                                    background: #252526;

                                    HorizontalLayout {
                                        padding-left: 12px;
                                        Text {
                                            text: "SOURCE";
                                            color: Theme.text-muted;
                                            font-size: 11px;
                                            font-weight: 600;
                                            vertical-alignment: center;
                                        }
                                    }
                                }

                                // Source text editor
                                source-editor := TextEdit {
                                    vertical-stretch: 1;
                                    text <=> node-content;
                                    font-size: 14px;
                                    wrap: word-wrap;
                                    edited(text) => {
                                        AppCallbacks.content-changed(text);
                                    }
                                }
                            }
                        }

                        // Splitter
                        Rectangle {
                            width: 4px;
                            background: splitter-touch.has-hover ? Theme.focus : Theme.border;

                            splitter-touch := TouchArea {
                                mouse-cursor: ew-resize;
                            }
                        }

                        // Visual Editor (right panel - CosmicTextEditor)
                        Rectangle {
                            horizontal-stretch: 1;
                            background: Theme.editor-bg;

                            VerticalLayout {
                                // Visual header
                                Rectangle {
                                    height: 24px;
                                    background: #252526;

                                    HorizontalLayout {
                                        padding-left: 12px;
                                        spacing: 8px;

                                        Text {
                                            text: "VISUAL";
                                            color: Theme.text-muted;
                                            font-size: 11px;
                                            font-weight: 600;
                                            vertical-alignment: center;
                                        }
                                    }
                                }

                                // Cosmic text editor
                                CosmicTextEditor {
                                    vertical-stretch: 1;
                                    text <=> root.cosmic-editor-text;
                                    rendered-image <=> root.cosmic-editor-image;
                                    content-height <=> root.cosmic-content-height;
                                    max-scroll-y <=> root.cosmic-max-scroll-y;
                                    scroll-y <=> root.cosmic-scroll-y;

                                    // Table toolbar bindings
                                    table-cell-selected <=> root.table-cell-selected;
                                    table-toolbar-x <=> root.table-toolbar-x;
                                    table-toolbar-y <=> root.table-toolbar-y;

                                    text-changed(new-text) => {
                                        root.node-content = new-text;
                                        AppCallbacks.content-changed(new-text);
                                    }

                                    key-pressed(key, shift, ctrl, alt) => {
                                        AppCallbacks.cosmic-key-pressed(key, shift, ctrl, alt);
                                    }

                                    mouse-clicked(x, y) => {
                                        AppCallbacks.cosmic-mouse-clicked(x, y);
                                    }

                                    mouse-dragged(x, y) => {
                                        AppCallbacks.cosmic-mouse-dragged(x, y);
                                    }

                                    request-render(w, h, scroll-y, zoom) => {
                                        AppCallbacks.cosmic-request-render(w, h, scroll-y, zoom);
                                    }

                                    focus-changed(focused) => {
                                        AppCallbacks.cosmic-focus-changed(focused);
                                    }

                                    request-blink-update() => {
                                        AppCallbacks.cosmic-blink-update();
                                    }

                                    // Table toolbar callbacks
                                    table-add-row-above => {
                                        AppCallbacks.table-add-row-above();
                                    }
                                    table-add-row-below => {
                                        AppCallbacks.table-add-row-below();
                                    }
                                    table-add-column-left => {
                                        AppCallbacks.table-add-column-left();
                                    }
                                    table-add-column-right => {
                                        AppCallbacks.table-add-column-right();
                                    }
                                    table-delete-row => {
                                        AppCallbacks.table-delete-row();
                                    }
                                    table-delete-column => {
                                        AppCallbacks.table-delete-column();
                                    }
                                }
                            }
                        }
                    }

                    // Empty state
                    if node-title == "": Rectangle {
                        vertical-stretch: 1;

                        Text {
                            text: "Select a node to view its content";
                            color: Theme.text-muted;
                            font-size: 14px;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                }
            }
        }

        // Status bar
        Rectangle {
            height: 22px;
            background: Theme.statusbar-bg;

            HorizontalLayout {
                padding-left: 10px;
                padding-right: 10px;

                Text {
                    text: connection-status;
                    color: Theme.text-bright;
                    font-size: 12px;
                    vertical-alignment: center;
                }

                Rectangle { horizontal-stretch: 1; }
            }
        }
        }  // End VerticalLayout
    }  // End main container

    // Resize handles (invisible touch areas at window edges)
    // Left edge
    Rectangle {
        x: 0px;
        y: 8px;
        width: 5px;
        height: parent.height - 16px;
        background: transparent;
        TouchArea {
            mouse-cursor: ew-resize;
            moved => { AppCallbacks.start-window-resize("w"); }
        }
    }
    // Right edge
    Rectangle {
        x: parent.width - 5px;
        y: 8px;
        width: 5px;
        height: parent.height - 16px;
        background: transparent;
        TouchArea {
            mouse-cursor: ew-resize;
            moved => { AppCallbacks.start-window-resize("e"); }
        }
    }
    // Top edge
    Rectangle {
        x: 8px;
        y: 0px;
        width: parent.width - 16px;
        height: 5px;
        background: transparent;
        TouchArea {
            mouse-cursor: ns-resize;
            moved => { AppCallbacks.start-window-resize("n"); }
        }
    }
    // Bottom edge
    Rectangle {
        x: 8px;
        y: parent.height - 5px;
        width: parent.width - 16px;
        height: 5px;
        background: transparent;
        TouchArea {
            mouse-cursor: ns-resize;
            moved => { AppCallbacks.start-window-resize("s"); }
        }
    }
    // Top-left corner
    Rectangle {
        x: 0px;
        y: 0px;
        width: 8px;
        height: 8px;
        background: transparent;
        TouchArea {
            mouse-cursor: nwse-resize;
            moved => { AppCallbacks.start-window-resize("nw"); }
        }
    }
    // Top-right corner
    Rectangle {
        x: parent.width - 8px;
        y: 0px;
        width: 8px;
        height: 8px;
        background: transparent;
        TouchArea {
            mouse-cursor: nesw-resize;
            moved => { AppCallbacks.start-window-resize("ne"); }
        }
    }
    // Bottom-left corner
    Rectangle {
        x: 0px;
        y: parent.height - 8px;
        width: 8px;
        height: 8px;
        background: transparent;
        TouchArea {
            mouse-cursor: nesw-resize;
            moved => { AppCallbacks.start-window-resize("sw"); }
        }
    }
    // Bottom-right corner
    Rectangle {
        x: parent.width - 8px;
        y: parent.height - 8px;
        width: 8px;
        height: 8px;
        background: transparent;
        TouchArea {
            mouse-cursor: nwse-resize;
            moved => { AppCallbacks.start-window-resize("se"); }
        }
    }

    // Overlay to close menus when clicking outside
    if active-menu != "": Rectangle {
        x: 0px;
        y: 0px;
        width: 100%;
        height: 100%;
        background: transparent;
        TouchArea {
            clicked => { active-menu = ""; }
        }
    }

    // Dropdown menus (positioned absolutely, rendered last for z-order)
    // Positions: container offset (1px) + padding (12px) + Pimble title (60px) + button widths (~36px each)
    if active-menu == "file": DropdownMenu {
        menu-x: 73px;
        menu-y: 31px;
        items: file-menu-items;
        item-clicked(action-id) => {
            AppCallbacks.menu-item-clicked(action-id);
        }
        close => {
            active-menu = "";
        }
    }

    if active-menu == "edit": DropdownMenu {
        menu-x: 109px;
        menu-y: 31px;
        items: edit-menu-items;
        item-clicked(action-id) => {
            AppCallbacks.menu-item-clicked(action-id);
        }
        close => {
            active-menu = "";
        }
    }

    if active-menu == "view": DropdownMenu {
        menu-x: 145px;
        menu-y: 31px;
        items: view-menu-items;
        item-clicked(action-id) => {
            AppCallbacks.menu-item-clicked(action-id);
        }
        close => {
            active-menu = "";
        }
    }

    if active-menu == "help": DropdownMenu {
        menu-x: 191px;
        menu-y: 31px;
        items: help-menu-items;
        item-clicked(action-id) => {
            AppCallbacks.menu-item-clicked(action-id);
        }
        close => {
            active-menu = "";
        }
    }
}
